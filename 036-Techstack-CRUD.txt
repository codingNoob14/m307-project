0) Überblick* Create: fertig (/content/new ? POST /content).* Read: Liste /content & Detail /content/:slug.* Update: eigene Seite content_edit.hbs, optional mit neuem Bild.* Delete: Hard-Delete (für Schule ok). Tipp: Später Soft-Delete mit deleted_at.Wir ergänzen DB-Funktionen, Helper, Routen, Views und CSS.Alle Snippets sind der neuste Stand (inkl. Bugfixes: ownerId, Bild-Pfad, Edit-View-Name).
1) DB-Layer erweitern (db/index.js)1.1 listContents() – bestehender Code ersetzen // owner_id mitselektieren & mappenexport function listContents() {  if (!db) return [];  const rows = db.prepare(`    SELECT      c.id, c.title, c.description, c.category, c.image_path, c.slug,      c.created_at, c.owner_id,      u.name AS owner_name    FROM contents c    LEFT JOIN users u ON u.id = c.owner_id    ORDER BY c.created_at DESC  `).all();  return rows.map(r => ({    id: r.id,    title: r.title,    description: r.description,    category: r.category,    imagePath: r.image_path,    slug: r.slug,    ownerId: r.owner_id,    ownerName: r.owner_name,    createdAt: new Date(r.created_at)  }));}1.2 getContentBySlug(slug) – bestehender Code ersetzen // owner_id mitselektieren & mappenexport function getContentBySlug(slug) {  if (!db) return null;  const r = db.prepare(`    SELECT      c.id, c.title, c.description, c.category, c.image_path, c.slug,      c.created_at, c.owner_id, u.name AS owner_name    FROM contents c    LEFT JOIN users u ON u.id = c.owner_id    WHERE c.slug = ?    LIMIT 1  `).get(slug);  if (!r) return null;  return {    id: r.id,    title: r.title,    description: r.description,    category: r.category,    imagePath: r.image_path,    slug: r.slug,    ownerId: r.owner_id,    ownerName: r.owner_name,    createdAt: new Date(r.created_at),  };}1.3 Neu einfügen: getContentById, updateContent, deleteContentByIdDirekt unter getContentBySlug(...) einfügen.export function getContentById(id) {  if (!db) return null;  const r = db.prepare(`    SELECT      c.id, c.title, c.description, c.category, c.image_path, c.slug,      c.created_at, u.name AS owner_name, c.owner_id    FROM contents c    LEFT JOIN users u ON u.id = c.owner_id    WHERE c.id = ?    LIMIT 1  `).get(id);  if (!r) return null;  return {    id: r.id,    title: r.title,    description: r.description,    category: r.category,    imagePath: r.image_path,    slug: r.slug,    ownerId: r.owner_id,    ownerName: r.owner_name,    createdAt: new Date(r.created_at),  };}export function updateContent({ id, title, description, category, imagePath }) {  if (!db) return 0;  if (imagePath) {    const stmt = db.prepare(`      UPDATE contents      SET title = ?, description = ?, category = ?, image_path = ?      WHERE id = ?    `);    return stmt.run(title, description, category, imagePath, id).changes;  } else {    const stmt = db.prepare(`      UPDATE contents      SET title = ?, description = ?, category = ?      WHERE id = ?    `);    return stmt.run(title, description, category, id).changes;  }}export function deleteContentById(id) {  if (!db) return 0;  const stmt = db.prepare(`DELETE FROM contents WHERE id = ?`);  return stmt.run(id).changes;}
2) Template-Helper (Berechtigungen) in app.js2.1 app.engine Code ersetzenapp.engine(  "hbs",  engine({    extname: ".hbs",    defaultLayout: "main",    layoutsDir: path.join(__dirname, "views", "layouts"),    partialsDir: path.join(__dirname, "views", "partials"),    helpers: {      formatDate,      upper: (str) => String(str).toUpperCase(),      eq: (a, b) => a === b,      now: () => new Date(),      increment: (n) => Number(n) + 1,      decrement: (n) => Number(n) - 1,      gt: (a, b) => a > b,      lt: (a, b) => a < b,      canEdit(item, currentUser) {        if (!currentUser || !item) return false;        return currentUser.role === 'admin' || item.ownerId === currentUser.id;      },    },  }));app.set("view engine", "hbs");app.set("views", path.join(__dirname, "views"));
3) Edit & Delete Routen in app.js3.1 Imports oben erweitern:import {  getAllUsers,  getUserByEmail,  createUser,  insertContent,  listContents,  getContentBySlug,  getContentById,     // <— neu  updateContent,      // <— neu  deleteContentById   // <— neu} from "./db/index.js";3.2 Middleware: Besitzer/Administrator prüfen (Code ergänzen)// Besitzer/Administrator prüfen function requireOwnerOrAdmin(req, res, next) {  const { item } = res.locals;  const user = req.session.user;  if (!user) return res.redirect('/login?next=' + encodeURIComponent(req.originalUrl));  if (user.role === 'admin' || (item && item.ownerId === user.id)) return next();  return res.status(403).render("about", { title: "403 – Kein Zugriff" });}3.3 Detail-Route minimal anpassen (ownerId im View sicher)app.get("/content/:slug", (req, res, next) => {  const item = getContentBySlug(req.params.slug);  if (!item) return next();  const full = getContentById(item.id) || item; // ownerId sicherstellen  res.render("detail", { title: full.title, item: full });});3.4 Edit-Form anzeigen (eigene Seite content_edit.hbs)// Edit Form anzeigenapp.get("/content/:slug/edit", requireAuth, (req, res, next) => {  const item = getContentBySlug(req.params.slug);  if (!item) return next();  res.locals.item = getContentById(item.id); // für requireOwnerOrAdmin  return requireOwnerOrAdmin(req, res, () => {    res.render("content_edit", {           // <<< Dateiname exakt so!      title: `Bearbeiten: ${item.title}`,      item: res.locals.item,      categories: CATEGORIES    });  });});3.5 Update verarbeiten (mit optional neuem Bild)Bugfix enthalten: führenden / aus imagePath entfernen, bevor die alte Datei gelöscht wird.app.post("/content/:slug/edit", requireAuth, upload.single("image"), (req, res, next) => {  const existing = getContentBySlug(req.params.slug);  if (!existing) return next();  res.locals.item = getContentById(existing.id);  requireOwnerOrAdmin(req, res, async () => {    const { title, description, category } = req.body || {};    const errors = [];    if (!title?.trim()) errors.push("Titel ist erforderlich.");    if (!description?.trim()) errors.push("Beschrieb ist erforderlich.");    if (!CATEGORIES.includes(category)) errors.push("Ungültige Kategorie.");    let newImagePath = null;    if (req.file) newImagePath = "/uploads/" + req.file.filename;    if (errors.length) {      if (req.file) { try { fs.unlinkSync(path.join(uploadDir, req.file.filename)); } catch {} }      return res.status(400).render("content_edit", {        title: `Bearbeiten: ${existing.title}`,        item: { ...res.locals.item, title, description, category },        categories: CATEGORIES,        errors      });    }    // Altes Bild löschen, wenn ersetzt (führenden Slash strippen!)    if (newImagePath) {      try {        const rel = (res.locals.item?.imagePath || "").replace(/^\//, "");        const oldAbs = path.join(__dirname, "public", rel);        if (rel && fs.existsSync(oldAbs)) fs.unlinkSync(oldAbs);      } catch {}    }    updateContent({      id: res.locals.item.id,      title: title.trim(),      description: description.trim(),      category,      imagePath: newImagePath || undefined    });    res.redirect(`/content/${existing.slug}`);  });});3.6 Delete (POST)Bugfix enthalten: imagePath korrekt auflösen.app.post("/content/:slug/delete", requireAuth, (req, res, next) => {  const item = getContentBySlug(req.params.slug);  if (!item) return next();  res.locals.item = getContentById(item.id);  requireOwnerOrAdmin(req, res, () => {    try {      const rel = (res.locals.item?.imagePath || "").replace(/^\//, "");      const abs = path.join(__dirname, "public", rel);      if (rel && fs.existsSync(abs)) fs.unlinkSync(abs);    } catch {}    deleteContentById(res.locals.item.id);    res.redirect("/content");  });});
4) Views4.1 Kartenliste views/content_list.hbs – kein Full-Overlay, Buttons sauber klickbar<h1>{{title}}</h1>{{#if items.length}}  <div class="grid grid--cards">    {{#each items}}      <article class="card">        <figure class="card__media">          <a href="/content/{{slug}}" aria-label="Details zu {{title}} öffnen">            <img src="{{imagePath}}" alt="{{title}}">          </a>        </figure>        <div class="card__body">          <h3 class="card__title">            <a href="/content/{{slug}}">{{title}}</a>          </h3>          <p class="card__meta">            {{category}} • von {{ownerName}}          </p>          {{#if (canEdit this ../currentUser)}}            <div class="card__actions" style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap;">              <a class="btn btn--sm" href="/content/{{slug}}/edit">Bearbeiten</a>              <form method="post" action="/content/{{slug}}/delete" style="display:inline;" onsubmit="return confirm('Eintrag löschen?');">                <button type="submit" class="btn btn--sm btn--danger">Löschen</button>              </form>            </div>          {{/if}}        </div>      </article>    {{/each}}  </div>{{else}}  <p>Noch keine Inhalte.</p>{{/if}}4.2 Edit-Seite views/content_edit.hbs (eigene Seite)<div class="page--edit">  <h1>{{title}}</h1>  {{#if errors}}    <div class="alert alert--error" role="alert" aria-live="polite">      <ul>        {{#each errors}}<li>{{this}}</li>{{/each}}      </ul>    </div>  {{/if}}  <form method="post" enctype="multipart/form-data" class="form form--stack" autocomplete="off">    <div class="form__row">      <label for="title">Titel</label>      <input id="title" name="title" value="{{item.title}}" required>      <small class="form__hint">Kurzer, prägnanter Titel für Kachel & Detailseite.</small>    </div>    <div class="form__row">      <label for="description">Beschrieb</label>      <textarea id="description" name="description" rows="6" required>{{item.description}}</textarea>      <small class="form__hint">Empfehlung: 500–800 Zeichen.</small>    </div>    <div class="form__row">      <label for="category">Kategorie</label>      <select id="category" name="category" required>        {{#each categories}}          <option value="{{this}}" {{#if (eq ../item.category this)}}selected{{/if}}>{{this}}</option>        {{/each}}      </select>    </div>    <div class="form__row">      <label>Aktuelles Bild</label>      <figure class="detail__media">        <img src="{{item.imagePath}}" alt="Aktuelles Bild zu {{item.title}}">      </figure>      <small class="form__hint">Optional ein neues Bild hochladen — ersetzt das bestehende.</small>      <input type="file" name="image" accept="image/*">    </div>    <div class="form__row">      <label>URL-Slug</label>      <input value="{{item.slug}}" disabled>      <small class="form__hint">Slug bleibt stabil (SEO).</small>    </div>    <div class="form__actions">      <button type="submit" class="btn">Speichern</button>      <a href="/content/{{item.slug}}" class="btn btn--secondary">Abbrechen</a>    </div>  </form></div>
5) CSS (einbinden in views/layouts/main.hbs ? <head>)5.1 public/css/content_edit.css.page--edit{max-width:960px;margin:2rem auto;padding:0 1rem}.page--edit h1{font-size:clamp(1.6rem,2vw,2rem);line-height:1.2;margin:0 0 1rem}.alert{border-radius:8px;padding:.75rem 1rem;margin-bottom:1rem}.alert--error{background:#ffe9e9;color:#7a1a1a;border:1px solid #f2bcbc}.alert--error ul{margin:0;padding-left:1.25rem}.form.form--stack{display:grid;gap:1rem}.form__row label{display:block;font-weight:600;margin-bottom:.35rem}.form__row input[type=text],.form__row input[type=email],.form__row input[disabled],.form__row select,.form__row textarea{width:100%;border:1px solid #d7dbe0;background:#fff;border-radius:10px;padding:.7rem .85rem;font:inherit;outline:none;transition:border-color .15s,box-shadow .15s;box-sizing:border-box}.form__row input[disabled]{background:#f5f7f9;color:#7a8794}.form__row input:focus,.form__row select:focus,.form__row textarea:focus{border-color:#7aa6ff;box-shadow:0 0 0 3px rgba(96,140,255,.2)}.form__hint{display:block;font-size:.875rem;color:#6b7280;margin-top:.35rem}.detail__media{display:block;margin:.25rem 0 0}.detail__media img{max-width:min(100%,560px);width:100%;height:auto;border-radius:12px;border:1px solid #e5e7eb;display:block}.form__actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.25rem}.btn{appearance:none;border:none;border-radius:10px;padding:.6rem .9rem;font:inherit;line-height:1;cursor:pointer;background:#111827;color:#fff;transition:transform .05s,box-shadow .2s,opacity .2s;box-shadow:0 2px 8px rgba(17,24,39,.08);text-decoration:none;display:inline-flex;align-items:center;gap:.5rem}.btn:hover{opacity:.95}.btn:active{transform:translateY(1px)}.btn--secondary{background:#e5e7eb;color:#111827}.btn--danger{background:#c0392b;color:#fff}.btn--sm{padding:.45rem .7rem;border-radius:8px;font-size:.9rem}input[type=file]{border:1px dashed #cbd5e1;background:#f8fafc;padding:.75rem;border-radius:10px}5.2 public/css/content_new.css.page--new{max-width:960px;margin:2rem auto;padding:0 1rem}.page--new h1{font-size:clamp(1.6rem,2vw,2rem);line-height:1.2;margin:0 0 1rem}.errors{background:#ffe9e9;color:#7a1a1a;border:1px solid #f2bcbc;border-radius:8px;padding:.75rem 1rem;margin:0 0 1rem}.errors li{margin-left:1rem}.form{display:grid;gap:1rem}.form label{display:grid;gap:.4rem;font-weight:600}.form input[type=text],.form input[type=email],.form select,.form textarea,.form input[type=file]{width:100%;border:1px solid #d7dbe0;background:#fff;border-radius:10px;padding:.7rem .85rem;font:inherit;outline:none;transition:border-color .15s,box-shadow .15s;box-sizing:border-box}.form textarea{min-height:140px;line-height:1.5}.form input[type=file]{padding:.6rem;background:#f8fafc;border-style:dashed}.form input:focus,.form select:focus,.form textarea:focus{border-color:#7aa6ff;box-shadow:0 0 0 3px rgba(96,140,255,.2)}.form__hint{display:block;font-size:.875rem;color:#6b7280}.form button[type=submit]{appearance:none;border:none;border-radius:10px;padding:.7rem 1rem;font:inherit;line-height:1;cursor:pointer;background:#111827;color:#fff;transition:transform .05s,box-shadow .2s,opacity .2s;box-shadow:0 2px 8px rgba(17,24,39,.08)}.form button[type=submit]:hover{opacity:.95}.form button[type=submit]:active{transform:translateY(1px)}Einbinden im Layout (views/layouts/main.hbs, <head>)<link rel="stylesheet" href="/css/content_edit.css"><link rel="stylesheet" href="/css/content_new.css">
6) Quick-Test (manuell)1. Einloggen ? Neuer Inhalt erstellen.2. In der Liste Bearbeiten ? Seite content_Edit.hbs öffnet. Änderungen speichern.3. Beim Bildwechsel: neues Bild hochladen ? altes Bild wird aus /public/uploads entfernt.4. Löschen ? Eintrag weg, Datei gelöscht, Redirect zur Liste.5. Anderer User: Buttons nicht sichtbar; direkter Edit-Aufruf ? 403.