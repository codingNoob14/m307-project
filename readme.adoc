= readme zu M307, Projekt SSR
:toc:

== Idee:

Dieses Starterprojekt soll einen raschen Einstieg in das Modul "307, Interaktive Webseite mit Formular erstellen" ermöglichen.

== Benötigt wird:

=== node.js

Das Projekt soll mit node.js erstellt werden. Dazu ist es notwendig, node auf dem persönlichen Gerät zu installieren.

Die notwendige Software sowie Installationsanweisungen für die gebräuchlichsten Betriebssysteme sind unter https://nodejs.org/de/download verfügbar.

=== Programmier Werkzeuge

Im Grundsatz ist es nicht wichtig, welches Tooling verwendet wird, allerdings wird Visual Studio Code empfohlen.

Informationen zur Installation sind unter https://code.visualstudio.com/ verfügbar.

=== Erste Schritte

Den Code auf die lokale Maschine herunterladen. Git verwenden oder auf der Website nach dem Quellcode-Download suchen.

Mit einem Command-Prompt in das Projekt wechseln.

[source, bash]
.Projekt vorbereiten

----
npm install
----

[source, bash]
.Projekt starten
----
npm run dev
----

== Verfügbare Routen

- `GET /` – Startseite mit Datum und kurzer Begrüssung
- `GET /about` – Informationen zu Layouts, Partials und Helpern
- `GET /users` – Tabelle mit Beispielbenutzern (inkl. Datumsformatierung)

== Projektstruktur

- `app.js` – Express-Server, View-Engine, Routen, Helper-Registrierung
- `views/` – Handlebars-Templates
  - `layouts/main.hbs` – Grundlayout (HTML-Rahmen)
  - `partials/header.hbs`, `partials/footer.hbs` – wiederverwendbare Bausteine
  - `home.hbs`, `about.hbs`, `users.hbs` – Beispielseiten
- `helpers/formatDate.js` – Beispiel-Helper zur Datumsformatierung (de-CH)
- `public/` – statische Dateien (z. B. `css/styles.css`)
- `db/` – SQLite-Initialisierung und DB-Zugriff (`better-sqlite3`), DB-Datei unter `data/app.db`
- `package.json` – Skripte und Abhängigkeiten (`express`, `express-handlebars`, `nodemon`)

== Skripte

- `npm run dev` – Startet den Server mit `nodemon` (Reload bei Dateiänderungen)
- `npm start` – Startet den Server ohne Reload

== Bilder einfügen

Statische Dateien werden aus dem Ordner `public/` bereitgestellt (`app.use(express.static(...))`).

So fügst du ein Bild ein:

1. Lege die Bilddatei im Projekt unter `public/img/` ab, z. B. `public/img/logo.png`.
2. Verweise im Template über den öffentlichen Pfad (beginnt an `/`):

[source, handlebars]
----
<img src="/img/nodeSSRsymbol.png" alt="node.js mit SSR Symbolbild" width="160" height="160" loading="lazy" />
----

Hinweise:

- CSS-Hintergrundbilder: `background-image: url('/img/logo.png');`
- Dynamischer Bildpfad aus Daten:

[source, handlebars]
----
{{!-- context: { avatar: '/img/users/max.webp' } --}}
<img src="{{avatar}}" alt="Profilbild von Max" loading="lazy" />
----

- Nutze sinnvolle `alt`-Texte (Barrierefreiheit) und, wenn möglich, feste `width`/`height` zur besseren Layout-Stabilität.
- Empfohlene Formate: `webp`/`avif` (klein), `png` (Grafiken), `jpg/jpeg` (Fotos), `svg` (Vektoren).
- Ein Neustart des Servers ist nicht nötig; die Datei ist nach dem Speichern direkt unter `/img/...` erreichbar.

== Formularbeispiel: Namen senden

Formulardaten per POST an den Server senden, dort verarbeiten und eine Bestätigungsseite anzeigen.

[source, handlebars]
.erweitere `views/home.hbs` um folgendes Formular
----
<form action="/submit-name" method="post">
  <label for="name">Dein Name</label>
  <div>
    <input type="text" id="name" name="name" required placeholder="Max Muster" />
    <button type="submit">Senden</button>
  </div>
</form>
----

- Serverroute in `app.js` (Formulardaten lesen, Namen loggen, Bestätigungsseite rendern):

[source, js]
.`app.js` ergänzen
----
// Body-Parser aktivieren
app.use(express.urlencoded({ extended: false }));

// Formular-Submission: Namen empfangen und in der Konsole ausgeben
// POST-Ziel für das Formular
app.post('/submit-name', (req, res) => {
  const { name } = req.body || {};
  console.log(`Neuer Name empfangen: ${name ?? '<leer>'}`);
  res.render('submitted', { title: 'Danke', submittedName: name });
});
----

- Bestätigungsseite: `views/submitted.hbs`

Neue Datei `views/submitted.hbs` anlegen:

[source, handlebars]
.`views/submitted.hbs` erstellen
----
<section>
  <h1>{{title}}</h1>
  {{#if submittedName}}
    <p>Danke, <strong>{{submittedName}}</strong>. Dein Name wurde empfangen und auf dem Server-Log ausgegeben.</p>
  {{else}}
    <p>Es wurde kein Name übermittelt. Bitte gehe zurück und versuche es erneut.</p>
  {{/if}}
  <p><a href="/">Zurück zur Startseite</a></p>
</section>
----

Testen:

1. `npm run dev` starten und `http://localhost:3000` öffnen
2. Namen eingeben und absenden
3. Im Terminal/der Konsole sollte der Name erscheinen, im Browser die Bestätigungsseite

== Handlebars-Helper

Registrierte Helper in `app.js`:

- `formatDate(date)` – Formatiert ein Datum nach `de-CH`
- `upper(str)` – Wandelt einen String in GROSSBUCHSTABEN um
- `eq(a, b)` – Vergleicht zwei Werte auf Gleichheit

Beispiele in Templates:

[source, handlebars]
----
{{formatDate today}}
{{upper name}}
{{#if (eq role "admin")}}…{{/if}}
----

== Eigene Erweiterungen

Neue Route hinzufügen (Beispiel):

[source, js]
----
// in app.js
app.get('/contact', (req, res) => {
  res.render('contact', { title: 'Kontakt' });
});
----

Eigenen Helper registrieren (Beispiel: aktuelles Datum):

[source, js]
----
// in app.js beim engine-Setup
helpers: {
  // … bestehende Helper
  now: () => new Date(),
}
----

und im Template verwenden:

[source, handlebars]
----
© {{formatDate (now)}}
----

== Datenbank (SQLite)

Eine Datenbank soll die Benutzerdaten bereitstellen.

Die Benutzerliste (`/users`) wird aus einer SQLite-Datenbank gelesen. Beim ersten Start werden Tabelle und Beispieldaten automatisch angelegt.

Voraussetzung: Paket `better-sqlite3` installieren:

[source, bash]
.`package.json` prüfen, ob `better-sqlite3` in den Abhängigkeiten steht
----
"dependencies": {
  "express": "^4.19.2",
  "express-handlebars": "^8.0.3",
  "better-sqlite3": "^12.2.0"
},
----

Nach veränderung der `package.json`:
[source, bash]
.abhängigkeiten installieren
----
npm install
----

=== Datenbank-Initialisierung und Zugriff

Die Datei `db/index.js` übernimmt die Initialisierung der SQLite-Datenbank und stellt Funktionen zum Lesen der Benutzerdaten bereit.

.Beispiel: `db/index.js`
[source, js]
----
import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Fallback-Daten, falls better-sqlite3 nicht installiert ist
const fallbackUsers = [
  { id: 1, name: 'DB', role: 'admin', createdAt: new Date('2024-11-02') },
  { id: 2, name: 'Fallback', role: 'user', createdAt: new Date('2025-01-15') },
  { id: 3, name: 'Data', role: 'editor', createdAt: new Date('2025-07-01') },
];

let Database = null;
let db = null;

try {
  ({ default: Database } = await import('better-sqlite3'));
} catch (e) {
  console.warn('[db] better-sqlite3 nicht installiert – verwende Fallback-Daten.');
}

function ensureDatabase() {
  if (!Database) return null;
  const dataDir = path.join(__dirname, '..', 'data');
  fs.mkdirSync(dataDir, { recursive: true });
  const dbPath = path.join(dataDir, 'app.db');
  const instance = new Database(dbPath);

  // Migration
  instance.exec(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      role TEXT NOT NULL DEFAULT 'user',
      created_at TEXT NOT NULL
    );
  `);

  // Seed, falls leer
  const count = instance.prepare('SELECT COUNT(*) AS c FROM users').get().c;
  if (count === 0) {
    const insert = instance.prepare(
      'INSERT INTO users (name, role, created_at) VALUES (?, ?, ?)',
    );
    const now = new Date();
    insert.run('Max', 'admin', new Date('2024-11-02').toISOString());
    insert.run('Erika', 'user', new Date('2025-01-15').toISOString());
    insert.run('Sam', 'editor', new Date('2025-07-01').toISOString());
  }

  return instance;
}

db = ensureDatabase();

export function getAllUsers() {
  if (!db) return fallbackUsers;
  const stmt = db.prepare(
    'SELECT id, name, role, created_at FROM users ORDER BY id ASC',
  );
  const rows = stmt.all();
  return rows.map((r) => ({
    id: r.id,
    name: r.name,
    role: r.role,
    createdAt: new Date(r.created_at),
  }));
}

export function insertUser(name, role = 'user') {
  if (!db) return null;
  const stmt = db.prepare(
    'INSERT INTO users (name, role, created_at) VALUES (?, ?, ?)',
  );
  const info = stmt.run(name, role, new Date().toISOString());
  return info.lastInsertRowid;
}
----


==== Veränderungen an der `app.js`

Import der DB-Funktionen:

[source, js]
.`app.js` ergänzen
----
import { getAllUsers } from './db/index.js';
----

Entfernen der statischen Beispiel-Daten in der `/users`-Route und stattdessen die Datenbank abfragen:

[source, js]
.`app.js` anpassen, entfernen von `const users = [...]`
----
// Beispieldaten
const users = [
  { id: 1, name: 'Max', role: 'admin', createdAt: new Date('2024-11-02') },
  { id: 2, name: 'Erika', role: 'user', createdAt: new Date('2025-01-15') },
  { id: 3, name: 'Sam', role: 'editor', createdAt: new Date('2025-07-01') },
];
----

Ersetzen von 

[source, js]
----
app.get("/users", (req, res) => { 

  res.render("users", { 
    title: "Benutzer", 
    users 
  });
});
----

mit
[source, js]
----
app.get('/users', (req, res) => {
  const users = getAllUsers();
  res.render('users', {
    title: 'Benutzer',
    users
  });
});
----

Hinweise:

- DB-Datei liegt unter `data/app.db` (im `.gitignore`).
- Schema und Seed erfolgen automatisch beim Start (siehe `db/index.js`).
- Bei fehlendem `better-sqlite3` fällt die App auf feste Beispiel-Daten zurück (Konsole zeigt Hinweis).
- Zur Bearbeitung der DB-Datei kann z. B. das Tool "DB Browser for SQLite" verwendet werden: https://sqlitebrowser.org/

== Fehlerbehebung

- „Port already in use“: Anderen Port setzen, z. B. `PORT=4000 npm run dev` (PowerShell: `$env:PORT=4000; npm run dev`).
- „Missing helper: now“: Entweder den Aufruf im `views/partials/footer.hbs` anpassen oder den einfachen `now`-Helper (siehe oben) ergänzen.
- „Command not found: nodemon“: `npm install` ausführen (dev-Abhängigkeit), oder alternativ `npm start` verwenden.
- Node-Version zu alt: Mit `node -v` prüfen und ggf. aktualisieren (oder `nvm` verwenden).

== Lizenz

Der Quellcode steht unter der MIT-Lizenz. Details siehe Datei `LICENSE`.
Kurzfassung: Nutzung, Kopie, Änderung und Verbreitung sind erlaubt – ohne Gewährleistung.
